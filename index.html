<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsenal del DM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=IM+Fell+English+SC&display=swap"
        rel="stylesheet">
    <link rel="shortcut icon"
        href="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/i/465e4532-5430-4be7-b49c-acf81087d8bd/dk17bz4-f9c81319-b029-4470-9675-b67c2fd91bf0.png"
        type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="controls-panel">
            <div class="panel-logo-container">
                <img src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/465e4532-5430-4be7-b49c-acf81087d8bd/dk16kcf-77b0443f-cc50-45d6-a19d-de78a6dcb6e6.png/v1/fill/w_894,h_894/logo1_by_rafaelalvarez29_dk16kcf-pre.png?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7ImhlaWdodCI6Ijw9MTAyNCIsInBhdGgiOiJcL2ZcLzQ2NWU0NTMyLTU0MzAtNGJlNy1iNDljLWFjZjgxMDg3ZDhiZFwvZGsxNmtjZi03N2IwNDQzZi1jYzUwLTQ1ZDYtYTE5ZC1kZTc4YTZkY2I2ZTYucG5nIiwid2lkdGgiOiI8PTEwMjQifV1dLCJhdWQiOlsidXJuOnNlcnZpY2U6aW1hZ2Uub3BlcmF0aW9ucyJdfQ.YtjWIIde6uE-Q4uflRtmthgIoWGsVSYs6MqcARV12B8"
                    alt="Logo de la Aplicaci√≥n" class="panel-logo">
            </div>

            <h2>Arsenal del DM </h2>
            <p class="panel-subtitle divisor">Herramientas para Forjar tu Aventura</p>


            <section class="collapsible active">
                <h3 class="collapsible-header">üó∫Ô∏è Mapa y Escena</h3>
                <div class="collapsible-content">
                    <!-- Input oculto para cargar mapa -->
                    <input type="file" id="mapImageInput" accept="image/*" class="hidden-file-input">
                    <label for="mapImageInput" class="custom-file-upload-btn">
                        Cargar Mapa de Fondo
                    </label>
                    <span id="fileNameDisplay" class="file-name-display">Ning√∫n archivo seleccionado</span>

                    <!-- NUEVO BOT√ìN PARA VER MAPAS GUARDADOS -->

                    <div class="button-group">
                        <button id="saveStateBtn">Guardar Escena</button>
                        <button id="loadStateBtn">Cargar Escena</button>
                    </div>
                </div>
            </section>

            <!-- El resto de las secciones del panel de control permanecen sin cambios -->
            <section class="collapsible">
                <h3 class="collapsible-header">‚öíÔ∏è Herramientas del DM</h3>
                <div class="collapsible-content">
                    <h4>‚ñ¶ Rejilla</h4>
                    <div class="checkbox-container">
                        <input type="checkbox" id="gridToggle">
                        <label for="gridToggle">Mostrar Rejilla</label>
                    </div> <label for="gridColor">Color:</label>
                    <input type="color" id="gridColor" value="#000000">
                    <label for="gridOpacity">Opacidad:</label>
                    <input type="range" class="range1" id="gridOpacity" min="0" max="1" step="0.1" value="0.5">

                    <label for="cellSize">Tama√±o de Casilla (px):</label>
                    <input type="number" id="cellSize" value="50" min="10">
                    <input type="range" id="cellSizeSlider" min="10" max="150" value="50">


                    <h4 class="top-margin">üñåÔ∏è Pincel de Niebla</h4>
                    <div class="radio-group">
                        <div> <!-- Envolvemos cada par -->
                            <input type="radio" id="brushReveal" name="brushMode" value="reveal" checked>
                            <label for="brushReveal">Revelar</label>
                        </div>
                        <div>
                            <input type="radio" id="brushHide" name="brushMode" value="hide">
                            <label for="brushHide">Ocultar</label>
                        </div>
                    </div>
                    <label for="brushSize">Tama√±o Pincel:</label>
                    <input type="range" id="brushSize" min="10" max="300" step="5" value="50">
                </div>
            </section>

            <section class="collapsible">
                <h3 class="collapsible-header">üß± Muros y Puertas</h3>
                <div class="collapsible-content">
                    <!-- NUEVOS RADIO BUTTONS PARA ELEGIR TIPO DE TRAZO -->
                    <h4>Tipo de Trazado</h4>
                    <div class="radio-tile-group">
                        <!-- Opci√≥n Muro -->
                        <div class="input-container">
                            <input id="drawTypeWall" class="radio-button" type="radio" name="drawType" value="wall"
                                checked>
                            <div class="radio-tile">
                                <span class="radio-tile-icon">üß±</span>
                                <label for="drawTypeWall" class="radio-tile-label">Muro</label>
                            </div>
                        </div>
                        <!-- Opci√≥n Puerta -->
                        <div class="input-container">
                            <input id="drawTypeDoor" class="radio-button" type="radio" name="drawType" value="door">
                            <div class="radio-tile">
                                <span class="radio-tile-icon">üö™</span>
                                <label for="drawTypeDoor" class="radio-tile-label">Puerta</label>
                            </div>
                        </div>
                    </div>
                    <p class="help-text">Dibuja muros para bloquear la visi√≥n o puertas que puedas abrir y cerrar.</p>

                    <!-- Botones de control -->
                    <button id="toggleWallModeBtn">Activar Modo Dibujo</button>
                    <div class="button-group">
                        <button id="undoWallBtn" class="secondary">Deshacer √öltimo</button>
                        <button id="clearWallsBtn" class="secondary">Limpiar Todo</button>
                    </div>
                </div>
            </section>

            <section id="doorControlsSection" class="collapsible">
                <h3 class="collapsible-header">üö™ Control de Accesos</h3>
                <div class="collapsible-content">
                    <ul id="doorList">
                        <!-- La lista de puertas se generar√° aqu√≠ con JavaScript -->
                    </ul>
                    <p id="noDoorsMessage" class="help-text">No has dibujado ninguna puerta o acceso secreto.</p>
                </div>
            </section>

            <!-- FORMULARIO A√ëADIR FICHA (con etiqueta de vida actualizada) -->
            <section class="collapsible">
                <h3 class="collapsible-header">‚ûï A√±adir Ficha Nueva</h3>
                <div class="collapsible-content">
                    <div class="token-editor-form"> <!-- Reutilizamos la clase para estilos consistentes -->

                        <h4>Informaci√≥n B√°sica</h4>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <div class="radio-tile-group">
                                <!-- Opci√≥n Jugador -->
                                <div class="input-container">
                                    <input id="typePlayer" class="radio-button" type="radio" name="tokenType"
                                        value="player" checked>
                                    <div class="radio-tile">
                                        <span class="radio-tile-icon">üõ°Ô∏è</span>
                                        <label for="typePlayer" class="radio-tile-label">Jugador</label>
                                    </div>
                                </div>
                                <!-- Opci√≥n Enemigo -->
                                <div class="input-container">
                                    <input id="typeEnemy" class="radio-button" type="radio" name="tokenType"
                                        value="enemy">
                                    <div class="radio-tile">
                                        <span class="radio-tile-icon">üëπ</span>
                                        <label for="typeEnemy" class="radio-tile-label">Enemigo</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tokenName">Nombre:*</label>
                            <input type="text" id="tokenName" placeholder="Ej: Grog Strongjaw">
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex-grow: 1;">
                                <label for="tokenLetter">Letra (ID Ficha):*</label>
                                <input type="text" id="tokenLetter" maxlength="2" value="">
                            </div>
                            <div class="form-group" style="flex-grow: 2;">
                                <label for="tokenImageInput">o Imagen de Ficha:</label>
                                <div class="file-upload-wrapper">
                                    <input type="file" id="tokenImageInput"
                                        accept="image/png, image/jpeg, image/webp, image/gif" class="hidden-file-input">
                                    <label for="tokenImageInput" class="custom-file-upload-btn small-btn">Cargar
                                        Imagen</label>
                                    <span id="tokenImageName" class="file-name-display">Ning√∫n archivo...</span>
                                </div>
                            </div>
                        </div>

                        <h4>Estad√≠sticas</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tokenTurn">Turno (Iniciativa):</label>
                                <!-- CORRECCI√ìN: A√±adido value por defecto -->
                                <input type="number" id="tokenTurn" value="10">
                            </div>
                            <div class="form-group">
                                <label for="tokenVision">Visi√≥n (casillas):*</label>
                                <!-- CORRECCI√ìN: A√±adido value por defecto -->
                                <input type="number" id="tokenVision" value="6" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tokenHealth">Vida Inicial:</label>
                            <input type="number" id="tokenHealth" value="">
                        </div>

                        <h4>Apariencia</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tokenColor">Color Relleno:*</label>
                                <input type="color" id="tokenColor" value="#4a90e2">
                            </div>
                            <div class="form-group">
                                <label for="tokenBorderColor">Color Borde:*</label>
                                <input type="color" id="tokenBorderColor" value="#000000">
                                <div class="checkbox-container" style="margin-top: 8px;">
                                    <input type="checkbox" id="addBorderCheckbox">
                                    <label for="addBorderCheckbox">A√±adir Borde</label>
                                </div>
                            </div>
                        </div>

                        <h4>Notas</h4>
                        <div class="form-group">
                            <textarea id="tokenNotes" rows="3"
                                placeholder="Describe caracter√≠sticas especiales..."></textarea>
                        </div>

                        <button id="addTokenBtn">A√±adir Ficha</button>

                    </div>
                </div>
            </section>

            <!-- FORMULARIO FICHA SELECCIONADA (Totalmente reconstruido) -->
            <section id="selectedTokenSection" class="collapsible">
                <h3 class="collapsible-header">üìç Ficha Seleccionada</h3>
                <div class="collapsible-content">
                    <p id="noTokenSelected">...</p>
                    <div id="tokenEditor" class="token-editor-form">

                        <div id="editTokenImagePreviewContainer">
                            <!-- Vista previa de la IMAGEN -->
                            <img id="editTokenImagePreview" src="" alt="Imagen de la Ficha">
                            <!-- Vista previa de la LETRA/COLOR (se mostrar√° u ocultar√° con JS) -->
                            <div id="editTokenLetterPreview" class="token-preview-letter"></div>

                            <!-- Botones de acci√≥n -->
                            <label for="editTokenImageInput" class="change-image-btn"
                                title="Cargar/Cambiar imagen">‚úèÔ∏è</label>
                            <button id="removeTokenImageBtn" class="remove-image-btn" title="Quitar imagen">X</button>
                            <input type="file" id="editTokenImageInput"
                                accept="image/png, image/jpeg, image/webp, image/gif" class="hidden-file-input">


                        </div>

                        <div class="form-header">
                            <h3>Configuraci√≥n de Personaje</h3>
                        </div>

                        <h4>Informaci√≥n B√°sica</h4>
                        <div class="form-row">
                            <div class="form-group" style="flex-grow: 2;"><label
                                    for="editTokenName">Nombre*</label><input type="text" id="editTokenName"></div>
                            <div class="form-group" style="flex-grow: 1;"><label for="editTokenLetter">ID
                                    Ficha*</label><input type="text" id="editTokenLetter" maxlength="2"></div>
                        </div>

                        <h4>Estad√≠sticas</h4>
                        <div class="form-row">
                            <div class="form-group"><label for="editTokenTurn">Turno (Iniciativa)</label><input
                                    type="number" id="editTokenTurn"></div>
                            <div class="form-group"><label for="editTokenVision">Visi√≥n (Casillas)*</label><input
                                    type="number" id="editTokenVision" min="0"></div>
                        </div>
                        <div class="form-group"><label for="editTokenHealthMax">Vida M√°xima</label><input type="number"
                                id="editTokenHealthMax" min="0"></div>

                        <!-- NUEVA SECCI√ìN DE CONTROLES DE VIDA -->
                        <div class="health-controls">
                            <label>Puntos de Vida Actuales</label>
                            <div id="healthDisplayContainer" class="health-display-container">
                                <span id="healthDisplay" class="health-display">100</span>
                                <!-- Los n√∫meros flotantes se a√±adir√°n aqu√≠ con JS -->
                            </div>
                            <div class="health-modifier-row">
                                <button class="health-modifier-btn negative" data-amount="-10">-10</button>
                                <button class="health-modifier-btn negative" data-amount="-5">-5</button>
                                <button class="health-modifier-btn negative" data-amount="-1">-1</button>
                                <input type="text" id="healthModifierInput" class="health-modifier-input"
                                    placeholder="¬±">
                                <button class="health-modifier-btn positive" data-amount="1">+1</button>
                                <button class="health-modifier-btn positive" data-amount="5">+5</button>
                                <button class="health-modifier-btn positive" data-amount="10">+10</button>
                            </div>
                            <p class="help-text">Usa los botones o escribe un n√∫mero y presiona Enter.</p>
                        </div>

                        <h4>Apariencia</h4>
                        <div class="form-row">
                            <div class="form-group"><label for="editTokenColor">Color Relleno*</label><input
                                    type="color" id="editTokenColor"></div>
                            <div class="form-group"><label for="editTokenBorderColor">Color Borde*</label><input
                                    type="color" id="editTokenBorderColor"></div>
                        </div>

                        <h4>Notas</h4>
                        <div class="form-group"><textarea id="editTokenNotes" rows="4"
                                placeholder="Describe caracter√≠sticas especiales, habilidades o notas importantes..."></textarea>
                        </div>

                        <!-- NUEVA SECCI√ìN PARA GESTIONAR ESTADOS -->
                        <div id="tokenStatesEditor">
                            <h4>Estados y Efectos</h4>
                            <div class="form-row">
                                <div class="form-group" style="flex-grow: 1;">
                                    <label for="newStateEmoji">Emoji</label>
                                    <input type="text" id="newStateEmoji" placeholder="üî•" maxlength="2">
                                </div>
                                <div class="form-group" style="flex-grow: 3;">
                                    <label for="newStateDesc">Descripci√≥n del Estado</label>
                                    <input type="text" id="newStateDesc" placeholder="En llamas, -1d4 por turno">
                                </div>
                            </div>
                            <button id="addStateBtn" class="small-btn">A√±adir Estado</button>

                            <ul id="editTokenStatesList">
                                <!-- La lista de estados se generar√° aqu√≠ -->
                            </ul>
                        </div>

                        <div class="form-row button-group">
                            <button id="updateTokenBtn">Actualizar Ficha</button>
                            <button id="deselectTokenBtn" class="secondary">Deseleccionar</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="collapsible active"> <!-- Dejamos esta abierta por defecto -->
                <h3 class="collapsible-header">‚ôüÔ∏è Fichas en el Tablero (Turno)</h3>
                <div class="collapsible-content">
                    <ul id="tokenList"></ul>
                </div>
            </section>

            <div class="vision-controls-group">
                <button id="toggleVisionBtn">Iniciar Visi√≥n Din√°mica</button>
                <button id="resetFogBtn" title="Reiniciar toda la niebla de guerra">R</button>
            </div>
            <br>
            <p class="panel-subtitle leyenda">~ Creado por Rafael Alvarez ~</p>

        </div>

        <div id="mapContainer">
            <!-- El mensaje de bienvenida sigue aqu√≠ -->
            <div class="loading-state">
                <div class="loading-icon">üé≤</div>
                <h1>Tu Aventura Comienza Aqu√≠</h1>
                <h2>¬°Manos a la obra, DM!</h2>
                <p>Carga tu mapa y prepara la escena. Tus jugadores conf√≠an en ti para crear una experiencia
                    inolvidable.</p>
                <img src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/465e4532-5430-4be7-b49c-acf81087d8bd/dk1fb46-3fa3ffb8-cec7-408a-afa0-2a656e178fce.png/v1/fill/w_1148,h_696/dm_screen_by_rafaelalvarez29_dk1fb46-pre.png?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7ImhlaWdodCI6Ijw9Nzc2IiwicGF0aCI6IlwvZlwvNDY1ZTQ1MzItNTQzMC00YmU3LWI0OWMtYWNmODEwODdkOGJkXC9kazFmYjQ2LTNmYTNmZmI4LWNlYzctNDA4YS1hZmEwLTJhNjU2ZTE3OGZjZS5wbmciLCJ3aWR0aCI6Ijw9MTI4MCJ9XV0sImF1ZCI6WyJ1cm46c2VydmljZTppbWFnZS5vcGVyYXRpb25zIl19.Q09gTvWeGEluAHfA1EXSgMuWKnP2Og4oU3577nPw970"
                    alt="">
            </div>

            <!-- El NUEVO WRAPPER que contendr√° todo el mapa -->
            <div id="mapContentWrapper">
                <img id="mapImage" src="" alt="Mapa" style="-webkit-user-drag: none;">
                <canvas id="gridCanvas"></canvas>
                <canvas id="wallsCanvas"></canvas>
                <canvas id="visionCanvas"></canvas>
                <div id="tokensLayer"></div>
            </div>
            <div id="playerTurnTracker">
            </div>
        </div>
    </div>

    <!-- MODAL PARA NOMBRAR PUERTA (NUEVO) -->
    <div id="doorNameModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Nombrar Nuevo Acceso</h3>
            <label for="doorNameInput">Nombre de la Puerta / Acceso:</label>
            <input type="text" id="doorNameInput" placeholder="Ej: Puerta de Roble Reforzado">
            <div class="button-group">
                <button id="confirmDoorNameBtn">Crear Acceso</button>
                <button id="cancelDoorNameBtn" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA GUARDAR ESCENA -->
    <div id="saveSceneModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Guardar Escena</h3>
            <label for="sceneNameInput">Nombre de la Escena:</label>
            <input type="text" id="sceneNameInput" placeholder="Ej: Cripta del Rey Olvidado">
            <div class="button-group">
                <button id="confirmSaveSceneBtn">Guardar</button>
                <button id="cancelSaveSceneBtn" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA MOSTRAR ESCENAS GUARDADAS -->
    <div id="savedScenesModal" class="modal-overlay">
        <div class="saved-scenes-modal">
            <!-- Header del modal -->
            <div class="modal-header">
                <h1 class="modal-title">Mapas Guardados</h1>
                <button class="modal-close-btn" id="closeSavedScenesBtn">√ó</button>
            </div>
            <!-- Contenido scrolleable del modal -->
            <div class="modal-content-body">
                <div id="sceneListContainer" class="saved-scenes-grid">
                    <!-- Las tarjetas de escenas se generar√°n aqu√≠ con JavaScript -->
                </div>
            </div>
        </div>
    </div>


    <audio id="damage-sound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_895037d330.mp3"
        preload="auto"></audio>
    <audio id="heal-sound" src="https://cdn.pixabay.com/download/audio/2022/02/07/audio_a54f1f5062.mp3"
        preload="auto"></audio>

    <script src="script.js"></script>
</body>

</html>