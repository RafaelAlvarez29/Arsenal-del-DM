<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arsenal del DM</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=IM+Fell+English+SC&display=swap"
        rel="stylesheet">
    <link rel="shortcut icon"
        href="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/i/465e4532-5430-4be7-b49c-acf81087d8bd/dk17bz4-f9c81319-b029-4470-9675-b67c2fd91bf0.png"
        type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <div class="controls-panel">
            <div class="panel-logo-container">
                <img src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/465e4532-5430-4be7-b49c-acf81087d8bd/dk16kcf-77b0443f-cc50-45d6-a19d-de78a6dcb6e6.png/v1/fill/w_894,h_894/logo1_by_rafaelalvarez29_dk16kcf-pre.png?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7ImhlaWdodCI6Ijw9MTAyNCIsInBhdGgiOiJcL2ZcLzQ2NWU0NTMyLTU0MzAtNGJlNy1iNDljLWFjZjgxMDg3ZDhiZFwvZGsxNmtjZi03N2IwNDQzZi1jYzUwLTQ1ZDYtYTE5ZC1kZTc4YTZkY2I2ZTYucG5nIiwid2lkdGgiOiI8PTEwMjQifV1dLCJhdWQiOlsidXJuOnNlcnZpY2U6aW1hZ2Uub3BlcmF0aW9ucyJdfQ.YtjWIIde6uE-Q4uflRtmthgIoWGsVSYs6MqcARV12B8"
                    alt="Logo de la Aplicación" class="panel-logo">
            </div>

            <h2>Arsenal del DM </h2>
            <p class="panel-subtitle divisor">Herramientas para Forjar tu Aventura</p>


            <section class="collapsible active">
                <!-- CAMBIO: Añadir span para el icono -->
                <h3 class="collapsible-header"><span class="header-icon icon-map"></span> Mapa y Escena</h3>
                <div class="collapsible-content">
                    <!-- Input oculto para cargar mapa -->
                    <input type="file" id="mapImageInput" accept="image/*" class="hidden-file-input">
                    <label for="mapImageInput" class="custom-file-upload-btn">
                        Cargar Mapa de Fondo
                    </label>
                    <span id="fileNameDisplay" class="file-name-display">Ningún archivo seleccionado</span>

                    <!-- NUEVO BOTÓN PARA VER MAPAS GUARDADOS -->

                    <div class="button-group">
                        <button id="saveStateBtn">
                            <span class="btn-icon icon-save-scene"></span>
                            <span class="btn-text">Guardar Escena</span>
                        </button>
                        <button id="loadStateBtn">
                            <span class="btn-icon icon-load-scene"></span>
                            <span class="btn-text">Cargar Escena</span>
                        </button>

                    </div>
                </div>
            </section>

            <!-- El resto de las secciones del panel de control permanecen sin cambios -->
            <section class="collapsible">
                <!-- CAMBIO: Añadir span para el icono -->
                <h3 class="collapsible-header"><span class="header-icon icon-tools"></span> Herramientas del DM</h3>
                <div class="collapsible-content">
                    <h4><span class="header-icon icon-grid"></span> Rejilla</h4>
                    <div class="form-row">
                        <div class="checkbox-container">
                            <input type="checkbox" id="gridToggle">
                            <label for="gridToggle">Mostrar Rejilla</label>
                        </div>
                        <input type="color" id="gridColor" class="colorh" value="#000000">

                    </div>
                    <label for="gridOpacity">Opacidad:</label>
                    <input type="range" class="range1" id="gridOpacity" min="0" max="1" step="0.1" value="0.5">



                    <label for="cellSize">Tamaño de Casilla (px):</label>
                    <input type="number" id="cellSize" value="50" min="10" step="0.1">
                    <input type="range" id="cellSizeSlider" min="10" max="150" value="50" step="0.1"
                        aria-label="Ajustar tamaño de casilla">

                    <h4 class="top-margin"><span class="header-icon icon-align-grid"></span> Alinear Rejilla</h4>
                    <p class="help-text">Activa este modo y luego haz clic en la esquina superior izquierda de una
                        casilla en la imagen de tu mapa para alinear la rejilla.</p>
                    <div class="button-group">
                        <button id="alignGridModeBtn">Activar Modo Alineación</button>
                        <button id="resetGridOffsetBtn" class="secondary">Resetear</button>
                    </div>

                    <h4 class="top-margin"><span class="header-icon icon-brush"></span> Pincel de Niebla</h4>
                    <p class="help-text">
                        Activa un modo para pintar con el pincel. Si no hay ninguno activo, podrás mover el mapa.
                    </p>
                    <!-- NUEVO CONTENEDOR PARA LOS CONTROLES DEL PINCEL -->
                    <div class="fog-brush-controls">
                        <!-- Grupo de Checkboxes con diseño de "Tile" -->
                        <div class="checkbox-tile-group">
                            <!-- Checkbox para Revelar -->
                            <div class="input-container">
                                <input id="brushReveal" class="checkbox-button" type="checkbox" name="brushMode"
                                    value="reveal">
                                <label for="brushReveal" class="checkbox-tile">
                                    <span class="checkbox-tile-icon icon-reveal-fog"></span>
                                    <span class="checkbox-tile-label">Revelar</span>
                                </label>
                            </div>
                            <!-- Checkbox para Ocultar -->
                            <div class="input-container">
                                <input id="brushHide" class="checkbox-button" type="checkbox" name="brushMode"
                                    value="hide">
                                <label for="brushHide" class="checkbox-tile">
                                    <span class="checkbox-tile-icon icon-hide-fog"></span>
                                    <span class="checkbox-tile-label">Ocultar</span>
                                </label>
                            </div>
                        </div>
                        <!-- Contenedor para el slider de tamaño -->
                        <div class="brush-size-container">
                            <label for="brushSize">Tamaño Pincel:</label>
                            <input type="range" id="brushSize" min="10" max="300" step="5" value="50">
                        </div>
                    </div>
                </div> <!-- cierre de collapsible-content -->
            </section>

            <section class="collapsible">
                <!-- CAMBIO: Añadir span para el icono -->
                <h3 class="collapsible-header"><span class="header-icon icon-walls"></span> Muros y Puertas</h3>
                <div class="collapsible-content">
                    <!-- NUEVOS RADIO BUTTONS PARA ELEGIR TIPO DE TRAZO -->
                    <h4>Tipo de Trazado</h4>
                    <div class="radio-tile-group">
                        <!-- Opción Muro -->
                        <div class="input-container">
                            <input id="drawTypeWall" class="radio-button" type="radio" name="drawType" value="wall"
                                checked>
                            <div class="radio-tile">
                                <!-- CAMBIO: span vacío para el icono -->
                                <span class="radio-tile-icon icon-wall-draw"></span>
                                <label for="drawTypeWall" class="radio-tile-label">Muro</label>
                            </div>
                        </div>
                        <!-- Opción Puerta -->
                        <div class="input-container">
                            <input id="drawTypeDoor" class="radio-button" type="radio" name="drawType" value="door">
                            <div class="radio-tile">
                                <!-- CAMBIO: span vacío para el icono -->
                                <span class="radio-tile-icon icon-door-draw"></span>
                                <label for="drawTypeDoor" class="radio-tile-label">Puerta</label>
                            </div>
                        </div>
                    </div>
                    <p class="help-text">Dibuja muros para bloquear la visión o puertas que puedas abrir y cerrar.</p>

                    <!-- Botones de control -->
                    <button id="toggleWallModeBtn">Activar Modo Dibujo</button>
                    <div class="button-group">
                        <button id="undoWallBtn" class="secondary">
                            <!-- Contenedor para el icono de deshacer -->
                            <span class="btn-icon icon-undo"></span>
                            <!-- Contenedor para el texto -->
                            <span class="btn-text">Deshacer Último</span>
                        </button>
                        <button id="clearWallsBtn" class="secondary">
                            <!-- Contenedor para el icono de limpiar -->
                            <span class="btn-icon icon-clear-all"></span>
                            <!-- Contenedor para el texto -->
                            <span class="btn-text">Limpiar Todo</span>
                        </button>
                    </div>
                </div>
            </section>

            <section id="doorControlsSection" class="collapsible">
                <!-- CAMBIO: Añadir span para el icono -->
                <h3 class="collapsible-header"><span class="header-icon icon-doors"></span> Control de Accesos</h3>
                <div class="collapsible-content">
                    <ul id="doorList">
                        <!-- La lista de puertas se generará aquí con JavaScript -->
                    </ul>
                    <p id="noDoorsMessage" class="help-text">No has dibujado ninguna puerta o acceso secreto.</p>
                </div>
            </section>

            <section class="collapsible">
                <h3 class="collapsible-header"><span class="header-icon icon-ambiance"></span> Ambientación</h3>
                <div class="collapsible-content">
                    <div id="soundBoardGrid" class="sound-board-grid">
                        <!-- Fila 1: Ambientes (Loop) -->
                        <button class="sound-btn" data-sound-id="sound-tavern">Taverna</button>
                        <button class="sound-btn" data-sound-id="sound-forest">Bosque</button>
                        <button class="sound-btn" data-sound-id="sound-cave">Cueva</button>
                        <button class="sound-btn" data-sound-id="sound-rain">Lluvia</button>

                        <!-- Fila 2: Música (Loop) -->
                        <button class="sound-btn" data-sound-id="sound-combat">Combate</button>
                        <button class="sound-btn" data-sound-id="sound-tension">Tensión</button>
                        <button class="sound-btn" data-sound-id="sound-end-battle">Fin Batalla</button>
                        <button class="sound-btn" data-sound-id="sound-eendigolongroar">Roar Monstruo</button>

                        <!-- Fila 3: Efectos de Combate -->
                        <button class="sound-btn" data-sound-id="sound-Sword-slash">Espadazo</button>
                        <button class="sound-btn" data-sound-id="sound-sword-hit">Golpe Espada</button>
                        <button class="sound-btn" data-sound-id="sound-Fireball">Bola de Fuego</button>
                        <button class="sound-btn" data-sound-id="sound-explosion">Explosión</button>

                        <!-- Fila 4: Efectos de Entorno -->
                        <button class="sound-btn" data-sound-id="sound-magic">Hechizo</button>
                        <button class="sound-btn" data-sound-id="sound-monster">Grito</button>
                        <button class="sound-btn" data-sound-id="sound-coin">Moneda</button>
                        <button class="sound-btn" data-sound-id="sound-door-1">Puerta Chirría</button>
                        <button class="sound-btn" data-sound-id="sound-risasenlatadas">Risas enltatadas</button>


                        <!-- Fila 5: Efectos de Puerta -->
                        <button class="sound-btn" data-sound-id="sound-noknok">Toc-Toc</button>
                        <button class="sound-btn" data-sound-id="sound-noknok-1">Aporrear</button>

                    </div>
                </div>
            </section>

            <!-- FORMULARIO AÑADIR FICHA (con etiqueta de vida actualizada) -->
            <section class="collapsible">
                <!-- CAMBIO: Añadir span para el icono -->
                <h3 class="collapsible-header"><span class="header-icon icon-add-token"></span> Añadir Ficha Nueva</h3>
                <div class="collapsible-content">
                    <div class="token-editor-form"> <!-- Reutilizamos la clase para estilos consistentes -->

                        <h4>Información Básica</h4>
                        <div id="addTokenImagePreviewContainer" class="token-preview-container">
                            <!-- La imagen de previsualización se insertará aquí con JS -->
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <div class="radio-tile-group">
                                <!-- Opción Jugador -->
                                <div class="input-container">
                                    <input id="add_typePlayer" class="radio-button" type="radio" name="add_tokenType"
                                        value="player" checked>
                                    <div class="radio-tile">
                                        <span class="radio-tile-icon icon-player-type"></span>
                                        <label for="add_typePlayer" class="radio-tile-label">Jugador</label>
                                    </div>
                                </div>
                                <!-- Opción Enemigo -->
                                <div class="input-container">
                                    <input id="add_typeEnemy" class="radio-button" type="radio" name="add_tokenType"
                                        value="enemy">
                                    <div class="radio-tile">
                                        <span class="radio-tile-icon icon-enemy-type"></span>
                                        <label for="add_typeEnemy" class="radio-tile-label">Enemigo</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div>
                                <label for="tokenName">Nombre:*</label>
                                <input type="text" id="tokenName" placeholder="Ej: Grog Strongjaw">
                            </div>
                            <div>
                                <label for="tokenLetter">Letra:*</label>
                                <input type="text" id="tokenLetter" maxlength="2" placeholder="(ID Ficha)" value="">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex-grow: 1;">
                                <div class="form-group" style="flex-grow: 2;">
                                    <label for="tokenImageInput">Imagen de Ficha:</label>
                                    <div class="file-upload-wrapper">
                                        <input type="file" id="tokenImageInput"
                                            accept="image/png, image/jpeg, image/webp, image/gif"
                                            class="hidden-file-input">
                                        <label for="tokenImageInput" class="custom-file-upload-btn small-btn">Cargar
                                            Imagen</label>
                                        <span id="tokenImageName" class="file-name-display">Ningún archivo...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h4>Estadísticas</h4>
                        <!-- NUEVO: CARACTERÍSTICAS PRINCIPALES -->
                        <div class="char-stats-grid" id="add_char_stats_grid">
                            <!-- FUE -->
                            <div class="char-stat-card">
                                <label>FUE</label>
                                <span class="char-mod" id="add_str_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="add_str_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- DES -->
                            <div class="char-stat-card">
                                <label>DES</label>
                                <span class="char-mod" id="add_dex_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="add_dex_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- CON -->
                            <div class="char-stat-card">
                                <label>CON</label>
                                <span class="char-mod" id="add_con_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="add_con_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- INT -->
                            <div class="char-stat-card">
                                <label>INT</label>
                                <span class="char-mod" id="add_int_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="add_int_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- SAB -->
                            <div class="char-stat-card">
                                <label>SAB</label>
                                <span class="char-mod" id="add_wis_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="add_wis_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- CAR -->
                            <div class="char-stat-card">
                                <label>CAR</label>
                                <span class="char-mod" id="add_car_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="add_car_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                        </div>

                        <!-- NUEVO: ESTADÍSTICAS DE COMBATE -->
                        <div class="combat-stats-grid">
                            <!-- BONIF. COMPETENCIA -->
                            <div class="combat-stat-card">
                                <label class="combat-label-top">BONIF.</label>
                                <input type="number" class="combat-value-input nobackgrund" id="add_proficiency_bonus"
                                    value="2">
                                <label class="combat-label-bottom">COMPETENCIA</label>
                            </div>
                            <!-- MOD. INICIATIVA -->
                            <div class="combat-stat-card">
                                <label class="combat-label-top">MOD.</label>
                                <input type="number" class="combat-value-input nobackgrund" id="add_initiative_mod"
                                    value="0">
                                <label class="combat-label-bottom">INICIATIVA</label>
                            </div>
                            <!-- VELOCIDAD -->
                            <div class="combat-stat-card">
                                <label class="combat-label-top">VELOCIDAD</label>
                                <input type="number" class="combat-value-input nobackgrund" id="add_speed" value="30">
                                <label class="combat-label-bottom">PIES</label>
                            </div>
                            <!-- CLASE DE ARMADURA -->
                            <div class="combat-stat-card">
                                <label class="combat-label-top">CLASE DE</label>
                                <input type="number" class="combat-value-input nobackgrund" id="add_armor_class"
                                    value="10">
                                <label class="combat-label-bottom">ARMADURA</label>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="tokenVision">👁️Visión (casillas):*</label>
                                <input type="number" id="tokenVision" value="12" min="0">
                            </div>
                            <div class="form-group">
                                <label for="tokenHealth">♥️Vida Inicial:</label>
                                <input type="number" id="tokenHealth" value="">
                            </div>
                        </div>

                        <!-- NUEVO: TIRADAS DE SALVACIÓN -->
                        <h4>Tiradas de Salvación</h4>
                        <div class="saving-throws-list" id="add_saving_throws_list">
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="add_str_save_prof"
                                        class="save-prof-check"><label for="add_str_save_prof"></label></div> <span
                                    class="save-name">Fuerza (Fue)</span><span class="save-total"
                                    id="add_str_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="add_dex_save_prof"
                                        class="save-prof-check"><label for="add_dex_save_prof"></label></div> <span
                                    class="save-name">Destreza (Des)</span><span class="save-total"
                                    id="add_dex_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="add_con_save_prof"
                                        class="save-prof-check"><label for="add_con_save_prof"></label></div> <span
                                    class="save-name">Constitución (Con)</span><span class="save-total"
                                    id="add_con_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="add_int_save_prof"
                                        class="save-prof-check"><label for="add_int_save_prof"></label></div> <span
                                    class="save-name">Inteligencia (Int)</span><span class="save-total"
                                    id="add_int_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="add_wis_save_prof"
                                        class="save-prof-check"><label for="add_wis_save_prof"></label></div> <span
                                    class="save-name">Sabiduría (Sab)</span><span class="save-total"
                                    id="add_wis_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="add_car_save_prof"
                                        class="save-prof-check"><label for="add_car_save_prof"></label></div> <span
                                    class="save-name">Carisma (Car)</span><span class="save-total"
                                    id="add_car_save_total">+0</span>
                            </div>
                        </div>

                        <h4>Apariencia</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tokenColor">Relleno:*</label>
                                <input type="color" id="tokenColor" value="#4a90e2">
                                <div class="checkbox-container" style="margin-top: 8px;">
                                    <input type="checkbox" id="addBorderCheckbox">
                                    <label for="addBorderCheckbox">Añadir Borde</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="tokenBorderColor">Borde:*</label>
                                <input type="color" id="tokenBorderColor" value="#000000">
                                <div class="form-group">
                                    <label for="tokenSizeMultiplier">Tamaño (x casillas):</label>
                                    <input type="number" id="tokenSizeMultiplier" value="1" min="0.5" step="0.5">
                                </div>
                            </div>

                        </div>

                        <h4>Notas</h4>
                        <div class="form-group">
                            <textarea id="tokenNotes" rows="3"
                                placeholder="Describe características especiales..."></textarea>
                        </div>

                        <button id="addTokenBtn">Añadir Ficha</button>

                    </div>
                </div>
            </section>

            <!-- FORMULARIO FICHA SELECCIONADA -->
            <section id="selectedTokenSection" class="collapsible">
                <h3 class="collapsible-header"><span class="header-icon icon-selected-token"></span> Ficha Seleccionada
                </h3>
                <div class="collapsible-content">
                    <p id="noTokenSelected" class="no-tokens-message">Seleccione una ficha para ver su información...
                    </p>
                    <div id="tokenEditor" class="token-editor-form">

                        <div id="editTokenImagePreviewContainer">
                            <img id="editTokenImagePreview" src="" alt="Imagen de la Ficha">
                            <div id="editTokenLetterPreview" class="token-preview-letter"></div>
                            <label for="editTokenImageInput" class="change-image-btn"
                                title="Cargar/Cambiar imagen">✏️</label>
                            <button id="removeTokenImageBtn" class="remove-image-btn" title="Quitar imagen">X</button>
                            <input type="file" id="editTokenImageInput"
                                accept="image/png, image/jpeg, image/webp, image/gif" class="hidden-file-input">
                        </div>

                        <div class="form-header">
                            <h3>Configuración de Personaje</h3>
                        </div>

                        <h4>Información Básica</h4>
                        <div class="form-row">
                            <div class="form-group" style="flex-grow: 2;"><label
                                    for="editTokenName">Nombre*</label><input type="text" id="editTokenName"></div>
                            <div class="form-group" style="flex-grow: 1;"><label for="editTokenLetter">ID
                                    Ficha*</label><input type="text" id="editTokenLetter" maxlength="2"></div>
                        </div>

                        <h4>Estadísticas</h4>
                        <!-- NUEVO: CARACTERÍSTICAS PRINCIPALES EN EDITOR -->
                        <div class="char-stats-grid" id="edit_char_stats_grid">
                            <!-- FUE -->
                            <div class="char-stat-card">
                                <label>FUE</label>
                                <span class="char-mod" id="edit_str_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="edit_str_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- DES -->
                            <div class="char-stat-card">
                                <label>DES</label>
                                <span class="char-mod" id="edit_dex_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="edit_dex_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- CON -->
                            <div class="char-stat-card">
                                <label>CON</label>
                                <span class="char-mod" id="edit_con_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="edit_con_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- INT -->
                            <div class="char-stat-card">
                                <label>INT</label>
                                <span class="char-mod" id="edit_int_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="edit_int_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- SAB -->
                            <div class="char-stat-card">
                                <label>SAB</label>
                                <span class="char-mod" id="edit_wis_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="edit_wis_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                            <!-- CAR -->
                            <div class="char-stat-card">
                                <label>CAR</label>
                                <span class="char-mod" id="edit_car_mod">+0</span>
                                <div class="char-score-capsule">
                                    <input type="number" id="edit_car_score" class="char-score-input nobackgrund"
                                        value="10">
                                </div>
                            </div>
                        </div>

                        <!-- NUEVO: ESTADÍSTICAS DE COMBATE EN EDITOR -->
                        <div class="combat-stats-grid">
                            <!-- BONIF. COMPETENCIA -->
                            <div class="combat-stat-card">
                                <label class="combat-label-top">BONIF.</label>
                                <input type="number" class="combat-value-input nobackgrund" id="edit_proficiency_bonus"
                                    value="2">
                                <label class="combat-label-bottom">COMPETENCIA</label>
                            </div>
                            <!-- INICIATIVA FINAL (EL QUE YA EXISTÍA) -->
                            <div class="combat-stat-card">
                                <label class="combat-label-top">INICIATIVA</label>
                                <input type="number" class="combat-value-input nobackgrund" id="editTokenTurn">
                                <label class="combat-label-bottom">(FINAL)</label>
                            </div>
                            <!-- VELOCIDAD -->
                            <div class="combat-stat-card">
                                <label class="combat-label-top">VELOCIDAD</label>
                                <input type="number" class="combat-value-input nobackgrund" id="edit_speed" value="30">
                                <label class="combat-label-bottom">PIES</label>
                            </div>
                            <!-- CLASE DE ARMADURA -->
                            <div class="combat-stat-card">
                                <label class="combat-label-top">CLASE DE</label>
                                <input type="number" class="combat-value-input nobackgrund" id="edit_armor_class"
                                    value="10">
                                <label class="combat-label-bottom">ARMADURA</label>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group"><label for="editTokenVision">👁️Visión (Casillas)*</label><input
                                    type="number" id="editTokenVision" min="0"></div>
                            <div class="form-group"><label for="editTokenHealthMax">♥️Vida Máxima</label><input
                                    type="number" id="editTokenHealthMax" min="0"></div>
                        </div>

                        <!-- SECCIÓN DE CONTROLES DE VIDA -->
                        <div class="health-controls">
                            <label>Puntos de Vida Actuales</label>
                            <div id="healthDisplayContainer" class="health-display-container">
                                <span id="healthDisplay" class="health-display">100</span>
                            </div>
                            <div class="health-modifier-row">
                                <button class="health-modifier-btn negative" data-amount="-10">-10</button>
                                <button class="health-modifier-btn negative" data-amount="-5">-5</button>
                                <button class="health-modifier-btn negative" data-amount="-1">-1</button>
                                <input type="text" id="healthModifierInput" class="health-modifier-input"
                                    placeholder="±">
                                <button class="health-modifier-btn positive" data-amount="1">+1</button>
                                <button class="health-modifier-btn positive" data-amount="5">+5</button>
                                <button class="health-modifier-btn positive" data-amount="10">+10</button>
                            </div>
                            <p class="help-text">Usa los botones o escribe un número y presiona Enter.</p>
                        </div>

                        <!-- NUEVO: TIRADAS DE SALVACIÓN EN EDITOR -->
                        <h4>Tiradas de Salvación</h4>
                        <div class="saving-throws-list" id="edit_saving_throws_list">
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="edit_str_save_prof"
                                        class="save-prof-check"><label for="edit_str_save_prof"></label></div> <span
                                    class="save-name">Fuerza (Fue)</span><span class="save-total"
                                    id="edit_str_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="edit_dex_save_prof"
                                        class="save-prof-check"><label for="edit_dex_save_prof"></label></div> <span
                                    class="save-name">Destreza (Des)</span><span class="save-total"
                                    id="edit_dex_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="edit_con_save_prof"
                                        class="save-prof-check"><label for="edit_con_save_prof"></label></div> <span
                                    class="save-name">Constitución (Con)</span><span class="save-total"
                                    id="edit_con_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="edit_int_save_prof"
                                        class="save-prof-check"><label for="edit_int_save_prof"></label></div> <span
                                    class="save-name">Inteligencia (Int)</span><span class="save-total"
                                    id="edit_int_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="edit_wis_save_prof"
                                        class="save-prof-check"><label for="edit_wis_save_prof"></label></div> <span
                                    class="save-name">Sabiduría (Sab)</span><span class="save-total"
                                    id="edit_wis_save_total">+0</span>
                            </div>
                            <div class="save-throw-row">
                                <div class="checkbox-container"><input type="checkbox" id="edit_car_save_prof"
                                        class="save-prof-check"><label for="edit_car_save_prof"></label></div> <span
                                    class="save-name">Carisma (Car)</span><span class="save-total"
                                    id="edit_car_save_total">+0</span>
                            </div>
                        </div>

                        <h4 id="aoeHeader">Alcance y Áreas de Efecto</h4>
                        <div id="aoeControlsContainer" style="display: none;">
                            <div id="aoeShapeSelector" class="button-group">
                                <button id="aoeBtnLine" data-shape="line" title="Línea">Línea</button>
                                <button id="aoeBtnCone" data-shape="cone" title="Cono">Cono</button>
                                <button id="aoeBtnCube" data-shape="cube" title="Cubo">Cubo</button>
                                <button id="aoeBtnSphere" data-shape="sphere" title="Esfera">Esfera</button>
                                <button id="aoeBtnCylinder" data-shape="cylinder" title="Cilindro">Cilindro</button>
                            </div>
                            <div id="aoeParamsContainer" style="margin-top: 15px;">
                                <div id="params-line" class="aoe-params" style="display: none;">
                                    <div class="form-group">
                                        <label for="aoeLineWidth">Ancho de la Línea (casillas):</label>
                                        <input type="number" id="aoeLineWidth" value="1" min="1">
                                    </div>
                                </div>
                                <div id="params-cone" class="aoe-params" style="display: none;">
                                    <div class="form-group">
                                        <label for="aoeConeLength">Longitud del Cono (casillas):</label>
                                        <input type="number" id="aoeConeLength" value="6" min="1">
                                    </div>
                                </div>
                                <div id="params-cube" class="aoe-params" style="display: none;">
                                    <div class="form-group">
                                        <label for="aoeCubeSize">Tamaño del Cubo (casillas):</label>
                                        <input type="number" id="aoeCubeSize" value="3" min="1">
                                    </div>
                                </div>
                                <div id="params-sphere" class="aoe-params" style="display: none;">
                                    <div class="form-group">
                                        <label for="aoeSphereRadius">Radio de la Esfera (casillas):</label>
                                        <input type="number" id="aoeSphereRadius" value="4" min="1">
                                    </div>
                                </div>
                                <div id="params-cylinder" class="aoe-params" style="display: none;">
                                    <div class="form-group">
                                        <label for="aoeCylinderRadius">Radio del Cilindro (casillas):</label>
                                        <input type="number" id="aoeCylinderRadius" value="2" min="1">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="aoeColor">Color de Previsualización:</label>
                                <input type="color" id="aoeColor" value="#ff4500">
                            </div>
                        </div>

                        <h4>Apariencia</h4>
                        <div class="form-row">
                            <div class="form-group"><label for="editTokenColor">Relleno*</label><input type="color"
                                    id="editTokenColor"></div>
                            <div class="form-group"><label for="editTokenBorderColor">Borde*</label><input type="color"
                                    id="editTokenBorderColor"></div>
                            <div class="form-group">
                                <label for="editTokenSizeMultiplier">Tamaño (x casillas):</label>
                                <input type="number" id="editTokenSizeMultiplier" value="1" min="0.5" step="0.5">
                            </div>
                        </div>

                        <h4>Notas</h4>
                        <div class="form-group"><textarea id="editTokenNotes" rows="4"
                                placeholder="Describe características especiales, habilidades o notas importantes..."></textarea>
                        </div>

                        <div id="tokenStatesEditor">
                            <h4>Estados y Efectos</h4>
                            <div class="form-row">
                                <div class="form-group" style="flex-grow: 1;">
                                    <label for="newStateEmoji">Emoji</label>
                                    <input type="text" id="newStateEmoji" placeholder="🔥" maxlength="2">
                                </div>
                                <div class="form-group" style="flex-grow: 3;">
                                    <label for="newStateDesc">Descripción del Estado</label>
                                    <input type="text" id="newStateDesc" placeholder="En llamas, -1d4 por turno">
                                </div>
                            </div>
                            <button id="addStateBtn" class="small-btn">Añadir Estado</button>
                            <ul id="editTokenStatesList"></ul>
                        </div>
                        <div id="tokenAbilitiesEditor">
                            <h4>Habilidades Destacadas</h4>
                            <div id="editAbilitiesList" class="info-card-list">
                                <!-- Las tarjetas de habilidades se generarán aquí -->
                            </div>
                            <button id="addAbilityBtn" class="small-btn">Añadir Habilidad</button>
                        </div>

                        <!-- === NUEVA SECCIÓN: INVENTARIO === -->
                        <div id="tokenInventoryEditor">
                            <h4>Inventario</h4>
                            <div id="editInventoryList" class="info-card-list">
                                <!-- Las tarjetas de inventario se generarán aquí -->
                            </div>
                            <button id="addInventoryItemBtn" class="small-btn">Añadir Objeto</button>
                        </div>
                        <div class="form-row button-group">
                            <button id="updateTokenBtn">Actualizar Ficha</button>
                            <button id="deselectTokenBtn" class="secondary">Deseleccionar</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="collapsible active"> <!-- Dejamos esta abierta por defecto -->
                <h3 class="collapsible-header"><span class="header-icon icon-tokens"></span> Fichas en el Tablero
                    (Turno)</h3>
                <div class="collapsible-content">
                    <ul id="tokenList"></ul>
                </div>
            </section>

            <div class="vision-controls-group">
                <button id="toggleVisionBtn">Iniciar Visión Dinámica</button>
                <button id="resetFogBtn" title="Reiniciar toda la niebla de guerra">R</button>
            </div>
            <button id="openPlayerViewBtn">
                <span class="btn-icon icon-player-view"></span>
                <span class="btn-text">Abrir Vista de Jugador</span>
            </button>
            <br>
            <p class="panel-subtitle leyenda">~ Creado por Rafael Alvarez ~</p>

        </div>

        <div id="mapContainer">
            <div class="loading-state">
                <div class="loading-icon icon-dice-large"></div>
                <h1>Tu Aventura Comienza Aquí</h1>
                <h2>¡Manos a la obra, DM!</h2>
                <p>Carga tu mapa y prepara la escena. Tus jugadores confían en ti para crear una experiencia
                    inolvidable.</p>
                <img src="https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/465e4532-5430-4be7-b49c-acf81087d8bd/dk1fb46-3fa3ffb8-cec7-408a-afa0-2a656e178fce.png/v1/fill/w_1148,h_696/dm_screen_by_rafaelalvarez29_dk1fb46-pre.png?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ1cm46YXBwOjdlMGQxODg5ODIyNjQzNzNhNWYwZDQxNWVhMGQyNmUwIiwiaXNzIjoidXJuOmFwcDo3ZTBkMTg4OTgyMjY0MzczYTVmMGQ0MTVlYTBkMjZlMCIsIm9iaiI6W1t7ImhlaWdodCI6Ijw9Nzc2IiwicGF0aCI6IlwvZlwvNDY1ZTQ1MzItNTQzMC00YmU3LWI0OWMtYWNmODEwODdkOGJkXC9kazFmYjQ2LTNmYTNmZmI4LWNlYzctNDA4YS1hZmEwLTJhNjU2ZTE3OGZjZS5wbmciLCJ3aWR0aCI6Ijw9MTI4MCJ9XV0sImF1ZCI6WyJ1cm46c2VydmljZTppbWFnZS5vcGVyYXRpb25zIl19.Q09gTvWeGEluAHfA1EXSgMuWKnP2Og4oU3577nPw970"
                    alt="">
            </div>

            <div id="mapContentWrapper">
                <img id="mapImage" src="" alt="Mapa" style="-webkit-user-drag: none;">
                <canvas id="gridCanvas"></canvas>
                <canvas id="wallsCanvas"></canvas>
                <canvas id="visionCanvas"></canvas>
                <div id="tokensLayer"></div>
                <canvas id="aoeCanvas"></canvas>
            </div>
            <div id="playerTurnTracker">
            </div>
        </div>
    </div>

    <!-- MODAL PARA NOMBRAR PUERTA (NUEVO) -->
    <div id="doorNameModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Nombrar Nuevo Acceso</h3>
            <label for="doorNameInput">Nombre de la Puerta / Acceso:</label>
            <input type="text" id="doorNameInput" placeholder="Ej: Puerta de Roble Reforzado">
            <div class="button-group">
                <button id="confirmDoorNameBtn">Crear Acceso</button>
                <button id="cancelDoorNameBtn" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA GUARDAR ESCENA -->
    <div id="saveSceneModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Guardar Escena</h3>
            <label for="sceneNameInput">Nombre de la Escena:</label>
            <input type="text" id="sceneNameInput" placeholder="Ej: Cripta del Rey Olvidado">
            <div class="button-group">
                <button id="confirmSaveSceneBtn">Guardar</button>
                <button id="cancelSaveSceneBtn" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL PARA MOSTRAR ESCENAS GUARDADAS -->
    <div id="savedScenesModal" class="modal-overlay">
        <div class="saved-scenes-modal">
            <div class="modal-header">
                <h1 class="modal-title">Mapas Guardados</h1>
                <button class="modal-close-btn" id="closeSavedScenesBtn">×</button>
            </div>
            <div class="modal-content-body">
                <div id="sceneListContainer" class="saved-scenes-grid">
                    <div id="no-scenes-message">
                        <div class="icon icon-map-large"></div>
                        <h3>No hay mapas guardados</h3>
                        <p>Aún no has guardado ninguna escena. Crea una y guárdala para poder cargarla más tarde.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- === MODAL PARA AÑADIR HABILIDADES/INVENTARIO === -->
    <div id="featureInventoryModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalTitle">Añadir Nuevo Elemento</h3>
            <div class="form-group">
                <label for="modalNameInput">Nombre:</label>
                <input type="text" id="modalNameInput" placeholder="Ej: Furia del Bárbaro">
            </div>
            <div class="form-group">
                <label for="modalDescriptionInput">Descripción:</label>
                <textarea id="modalDescriptionInput" rows="4" placeholder="Describe los detalles..."></textarea>
            </div>
            <div class="button-group">
                <button id="confirmModalBtn">Guardar</button>
                <button id="cancelModalBtn" class="secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <audio id="damage-sound" src="https://www.myinstants.com/media/sounds/crap-dnd-song.mp3" preload="auto"></audio>
    <audio id="heal-sound" src="https://www.myinstants.com/media/sounds/crap-dnd-song.mp3" preload="auto"></audio>
    <audio id="sound-tavern" src="https://www.myinstants.com/media/sounds/crapdndsong_ICcww3d.mp3" preload="auto"
        loop></audio>
    <audio id="sound-forest" src="https://www.myinstants.com/media/sounds/forest-night.mp3" preload="auto" loop></audio>
    <audio id="sound-cave" src="https://www.myinstants.com/media/sounds/cave-ambience-3.mp3" preload="auto"
        loop></audio>
    <audio id="sound-combat" src="https://www.myinstants.com/media/sounds/.mp3" preload="auto" loop></audio>
    <audio id="sound-tension" src="https://www.myinstants.com/media/sounds/64-000-500-000-questions-mp3cut.mp3"
        preload="auto" loop></audio>
    <audio id="sound-magic" src="https://www.myinstants.com/media/sounds/magia.mp3" preload="auto"></audio>
    <audio id="sound-monster" src="https://www.myinstants.com/media/sounds/monster-scream-aggressive.mp3"
        preload="auto"></audio>
    <audio id="sound-eendigolongroar" src="https://www.myinstants.com/media/sounds/wendigo-long-roar.mp3" preload="auto"
        loop></audio>
    <audio id="sound-rain" src="https://www.myinstants.com/media/sounds/lluvia.mp3" preload="auto" loop></audio>
    <audio id="sound-coin" src="https://www.myinstants.com/media/sounds/coin.mp3" preload="auto"></audio>
    <audio id="sound-Sword-slash" src="https://www.myinstants.com/media/sounds/sword-slash.mp3" preload="auto"></audio>
    <audio id="sound-sword-hit" src="https://www.myinstants.com/media/sounds/sword-swing-hit.mp3"
        preload="auto"></audio>
    <audio id="sound-Fireball"
        src="https://www.myinstants.com/media/sounds/ghast-fireball-minecraft-sound-sound-effect-for-editing.mp3"
        preload="auto"></audio>
    <audio id="sound-noknok" src="https://www.myinstants.com/media/sounds/dnd-puerta.mp3" preload="auto"></audio>
    <audio id="sound-noknok-1" src="https://www.myinstants.com/media/sounds/dnd-aporreando.mp3" preload="auto"></audio>
    <audio id="sound-end-battle" src="https://www.myinstants.com/media/sounds/end-battle.mp3" preload="auto"
        loop></audio>
    <audio id="sound-door-1" src="https://www.myinstants.com/media/sounds/dndoor-squeak.mp3" preload="auto"></audio>
    <audio id="sound-explosion" src="https://www.myinstants.com/media/sounds/dnd-explosion.mp3" preload="auto"></audio>
    <audio id="sound-risasenlatadas" src="https://www.myinstants.com/media/sounds/risas-enlatadas-tv.mp3"
        preload="auto"></audio>

    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <script src="script.js"></script>
</body>

</html>